# PointSub 性能测试框架

本目录包含了 PointSub 智能消息传输系统的性能测试工具和框架。这些测试工具可用于评估 PointSub 系统在不同场景下的性能表现，包括吞吐量、延迟、并发性能、稳定性和错误恢复能力。

## 测试框架结构

```
profile/
  ├── cmd/               # 命令行工具和主程序
  │   └── perftest.go    # 性能测试主程序
  ├── perflib/           # 性能测试库
  │   ├── common.go      # 公共函数和数据结构
  │   ├── base_network.go # dep2p网络基础设施
  │   ├── throughput.go  # 吞吐量测试
  │   ├── latency.go     # 延迟测试
  │   ├── concurrency.go # 并发性能测试
  │   ├── stability.go   # 稳定性和错误恢复测试
  │   └── dataflow.go    # 大数据流测试
  └── results/           # 测试结果输出目录(运行时创建)
```

## 网络测试环境

本测试框架使用真实的 dep2p 网络环境进行测试，而不是简单的内存管道。这使得测试结果更加接近实际生产环境中的表现。

测试框架通过以下方式建立网络连接：
1. 创建两个 dep2p 主机实例，分配不同的端口
2. 建立主机间的连接，并设置协议
3. 使用 PointSub 的 Dial 和 Listen 方法在主机之间建立连接
4. 对连接进行各种性能测试

这种方式比使用 `net.Pipe()` 更能反映真实网络环境中的表现，包括网络延迟、数据处理开销等因素。

## 测试类型

本框架支持以下几种性能测试：

### 1. 吞吐量测试 (Throughput Tests)

评估系统在不同消息大小和负载下的数据传输能力：

- **小消息测试** (< 1KB)：测试小消息高频传输的性能
- **中等消息测试** (10KB-100KB)：测试中等大小消息的传输性能
- **大消息测试** (1MB-2MB)：重点测试 PointSub 系统处理大消息的能力
- **超大消息测试** (> 10MB)：测试系统处理超大消息的极限性能

### 2. 延迟测试 (Latency Tests)

评估消息传输的响应时间和延迟特性：

- **低负载延迟测试**：测试基础延迟水平
- **中等负载延迟测试**：测试一般负载下的延迟表现
- **高负载延迟测试**：测试高负载下的延迟表现
- **大消息延迟测试**：特别关注1MB-2MB大小消息的延迟特性

### 3. 并发性能测试 (Concurrency Tests)

评估系统在不同并发水平下的表现：

- **低并发测试**：少量连接高频发送消息
- **中等并发测试**：适中连接数模拟常规负载
- **高并发测试**：高连接数模拟高负载场景
- **大消息并发测试**：测试大消息在中等并发下的表现

### 4. 稳定性和错误恢复测试 (Stability Tests)

评估系统的可靠性和容错能力：

- **长时间稳定性测试**：长时间运行以验证系统稳定性
- **错误恢复测试**：注入随机错误，测试系统恢复能力

### 5. 大数据流测试 (DataFlow Tests)

评估系统在长时间持续传输大量数据的场景下的表现：

- **1MB消息大数据流测试**：使用1MB大小的消息持续传输10GB数据
- **2MB消息大数据流测试**：使用2MB大小的消息持续传输10GB数据

这些测试专门设计用于发现只有在长时间持续负载下才会出现的问题，如内存泄漏、性能下降、GC压力等。测试过程中会监控并记录内存使用、GC行为和性能波动等关键指标。

## 运行测试

使用以下命令运行性能测试：

```bash
# 编译测试程序 (在项目根目录下)
go build -o perftest pointsub/example/profile/cmd/perftest.go

# 运行所有测试
./perftest

# 只运行特定类型的测试
./perftest -type throughput  # 只运行吞吐量测试
./perftest -type latency     # 只运行延迟测试
./perftest -type concurrency # 只运行并发测试
./perftest -type stability   # 只运行稳定性测试
./perftest -type dataflow    # 只运行大数据流测试

# 启用详细日志
./perftest -verbose

# 指定结果输出目录
./perftest -output /path/to/results

# 记录CPU和内存概况 (用于性能分析)
./perftest -cpuprofile cpu.prof -memprofile mem.prof
```

## 测试结果分析

测试完成后，将在指定的输出目录生成CSV格式的结果文件。该文件包含以下指标：

- 测试名称
- 消息数量和总数据量
- 测试持续时间
- 平均吞吐量 (MB/s)
- 延迟统计 (平均、最小、最大、P50、P90、P99)
- 资源使用情况 (内存、CPU)
- 错误和重试次数

## 性能分析指南

可以使用Go内置的pprof工具对生成的性能分析文件进行分析：

```bash
# 分析CPU使用情况
go tool pprof -http=:8080 cpu.prof

# 分析内存使用情况
go tool pprof -http=:8080 mem.prof
```

## 定制测试

如需定制测试参数，可以修改各测试模块中的默认配置：

1. 吞吐量测试：调整消息大小、并发连接数和每个连接的消息数
2. 延迟测试：调整消息大小和发送间隔
3. 并发测试：调整连接数和消息大小
4. 稳定性测试：调整持续时间和错误注入率
5. 大数据流测试：调整消息大小、目标数据总量和采样间隔

## 注意事项

- 测试可能消耗大量系统资源，建议在专用测试环境中运行
- 长时间稳定性测试默认运行10分钟，实际生产测试可能需要数小时甚至更长时间
- 大数据流测试默认需要传输10GB数据，请确保有足够的网络带宽和系统资源
- 实际网络环境中的性能可能与本地测试有显著差异 

## 最新测试结果

### 2025年3月18日测试结果摘要

#### 吞吐量测试

| 消息大小 | 并发连接数 | 消息速率 (消息/秒) | 数据速率 | 
|---------|-----------|------------------|----------|
| 256字节  | 2         | 159.97          | 0.04 MB/s |
| 512字节  | 5         | 1,985.56        | 0.97 MB/s |
| 50KB    | 3         | 504.31          | 24.62 MB/s |
| 1MB     | 2         | 20.19           | 20.19 MB/s |
| 5MB     | 1         | 2.02            | 10.10 MB/s |

#### 延迟测试

| 负载条件 | 消息大小 | 发送间隔 | 消息数 | 数据速率 | 平均延迟 | 最大延迟 |
|---------|---------|---------|-------|----------|---------|---------|
| 低负载   | 1KB     | 100ms   | 297   | 0.01 MB/s | 0.00ms  | 0.00ms  |
| 中负载   | 10KB    | 50ms    | 588   | 0.18 MB/s | 0.01ms  | 4.00ms  |
| 高负载   | 100KB   | 10ms    | 2,722 | 8.31 MB/s | 0.00ms  | 2.00ms  |
| 大消息   | 1MB     | 500ms   | 120   | 1.95 MB/s | 0.01ms  | 1.00ms  |
| 大消息   | 2MB     | 500ms   | 120   | 3.89 MB/s | 0.03ms  | 2.00ms  |

#### 并发测试

| 测试场景 | 消息大小 | 并发连接数 | 发送消息数 | 接收消息数 | 总数据量 | 错误情况 |
|---------|---------|-----------|-----------|------------|---------|----------|
| 低并发   | 10KB    | 5         | 25,000    | 25,000     | 244.14MB | 大量I/O超时错误；程序panic |

#### 稳定性测试

| 测试场景 | 消息大小 | 连接数 | 持续时间 | 发送消息数 | 接收消息数 | 错误恢复 |
|---------|---------|--------|---------|-----------|-----------|----------|
| 长时间稳定性 | 10KB | 2 | 10分钟 | 35,842 | 35,842 | 100% |
| 错误恢复能力 | 1KB | 3 | 5分钟 | 15,000 | 14,678 | 97.85% |

#### 大数据流测试

| 消息大小 | 总数据量 | 消息数 | 吞吐量 | 平均内存使用 | GC次数 | 完成率 |
|---------|---------|--------|--------|------------|-------|--------|
| 1MB     | 10GB    | 10,240 | 18.53 MB/s | 6.21 MB | 312 | 100% |
| 2MB     | 10GB    | 5,120  | 17.98 MB/s | 9.67 MB | 278 | 100% |

#### 性能分析

1. **吞吐量特性**:
   - 小消息(512字节)在高并发(5)下达到约2,000消息/秒
   - 中等消息(50KB)实现了24.62 MB/秒的数据传输率
   - 随着消息大小增加，每秒处理的消息数量减少，但单位时间数据传输量增加

2. **延迟表现**:
   - 系统在各种负载条件下维持极低延迟，大多数情况下平均延迟接近0毫秒
   - 最高延迟出现在中等负载测试中，为4.00毫秒

3. **稳定性和错误恢复**:
   - 长时间稳定性测试中，系统在10分钟内保持100%稳定，无消息丢失
   - 在错误恢复测试中，注入随机错误后系统能恢复97.85%的消息传输

4. **大数据流性能**:
   - 系统能够稳定传输10GB数据，保持约18MB/秒的吞吐量
   - 内存使用保持在合理范围，没有出现内存泄漏或过度GC问题

注：以上测试在本地网络环境下进行，实际分布式环境中的性能可能有所不同。

完整测试结果和详细分析请参阅[完整测试报告](../TEST_RESULTS.md)。 